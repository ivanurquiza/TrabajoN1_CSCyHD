---
title: "Trabajo N°1"
author: "Integrantes: Tomás Baigorria e Iván Robles Urquiza"
date: 'Agosto 2023'
output: html_document
---

### Importación de librerías

```{r, echo = FALSE}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(sf)
library(viridis)
library(scales)
library(paletteer)
```

### Importación del del dataset primario

-   Importación de archivo de nomenclatura de codificación para departamentos
-   Matcheamos el nombre del departamento
-   *Visualizamos los primeros registros del dataset*

```{r}

cod_deptos <- read_csv("./Data/diccionario_cod_depto.csv") %>% 
            select(codigo_departamento_indec, nombre_departamento_indec)

cod_clae <- read_csv("./Data/diccionario_clae2.csv") %>% 
            select(clae2, letra_desc)

datos_geo <- read_sf("./Data/departamentos_arg.geojson") %>% 
             select(codigo_departamento_indec, geometry) %>% 
             mutate(codigo_departamento_indec = as.numeric(codigo_departamento_indec))

#geo_caba <- read_sf("./Data/ProvinciasArgentina.geojson") %>% 
#          filter(nombre == "Capital Federal") %>% 
#          select(nombre, geometry) %>% 
#          mutate(nombre= "CABA")

dfmain <- read_csv("./Data/w_mean_depto_tot_emp_clae2.csv") %>% 
        left_join(cod_deptos, by="codigo_departamento_indec") %>% 
        left_join(cod_clae, by="clae2") %>% 
        left_join(datos_geo, by = "codigo_departamento_indec") %>% 
        #mutate(geometry = ifelse(codigo_departamento_indec==2000, geo_caba[1,2], geometry)) %>% #Esta línea es la que mete CABA
        select(fecha, codigo_departamento_indec,nombre_departamento_indec, clae2, letra_desc, everything())


# Observamos algunos registros de dfmain

print(sample_n(dfmain, size = 10))

```

### Chequeamos la presencia de missing values y de valores inválidos en el dataset.

```{r}
cat("Cantidad de registros: ", nrow(dfmain), "\n")

print("NaNs por campo")
colSums(is.na(dfmain))

# Procedemos a borrar dichos registros por no ser significativos

dfmain <- na.omit(dfmain)

#Observamos la presencia de valores inválidos o absurdos en algunos departamentos (-99)

ejemplo <- dfmain %>% arrange(w_mean) %>% 
  slice(1:5)

print(ejemplo)

# Eliminamos los valores negativos

dfmain <- dfmain %>% filter(w_mean > 0)
```

# 1. Los departamentos con mayores salarios, expresados en un mapa coroplético.

Obtenemos por agrupación basada en los departamentos el promedio de los salarios. Para que la muestra no este sesgada por saltos discrecionales en los salarios promedio del último período registrado (04/2023), acotamos la muestra a los registros dell último año (media de los últimos 12 registros)

-   

```{r}

# Chequeamos datatype de los elementos de la columna
cat("Tipo de dato: ", class(dfmain$fecha), "\n")

# Detectamos rango de las fechas del dataset

range(dfmain$fecha)

# Acotamos la muestra

subdf_depto <- dfmain %>% 
                  filter(fecha > (max(fecha) - 365)) %>% 
                  group_by(codigo_departamento_indec, nombre_departamento_indec, geometry) %>% 
                  summarise(w_mean_lasty = round(mean(w_mean)))


head(subdf_depto)
                  
```

```{r}

ggplot(subdf_depto
        , aes(geometry = geometry)) +
        geom_sf(aes(fill = w_mean_lasty), color = NA) +
        theme_void() +
        scale_fill_paletteer_c("grDevices::Geyser", labels = label_comma()) +
        labs(fill = "Salario promedio") +
        ggtitle("Promedio salarial interanual por departamento")

```

### Por sector de actividad

```{r}

subdf_act_salarios <- dfmain %>% 
                  filter(fecha > (max(fecha) - 365)) %>% 
                  group_by(letra_desc) %>% 
                  summarise(w_mean_lasty = round(mean(w_mean))) %>% 
                  arrange(w_mean_lasty) %>% 
                  head(n=5) %>% 
                  mutate(letra_desc = fct_inorder(letra_desc))


ggplot(data = subdf_act_salarios, aes(x = letra_desc, y = w_mean_lasty, fill = letra_desc)) +
         geom_col() +
         scale_fill_paletteer_d("lisa::OskarSchlemmer") +
         labs(x = "",
              y = "Salario mensual promedio") +
         scale_x_discrete(labels = label_wrap(10)) +
         scale_y_continuous(labels = comma) +
         theme_minimal() +
         guides(fill = "none") +
         ggtitle("Top 5 rubros con menores remuneraciones")

```

```{r}
#Chequeamos los diferentes sectores

print(unique(dfmain$letra_desc))

subdf_act_serie <- dfmain %>% 
                select(fecha, letra_desc, w_mean) %>% 
                filter(letra_desc == "EXPLOTACION DE MINAS Y CANTERAS"
                       | letra_desc == "SERVICIO DE TRANSPORTE Y ALMACENAMIENTO"
                       | letra_desc == "CONSTRUCCIÓN"
                       | letra_desc == "ENSEÑANZA") %>% 
                group_by(fecha, letra_desc) %>% 
                summarise(w_mean = mean(w_mean))

ggplot(data = subdf_act_serie) +
    geom_line(aes(x = fecha, y = w_mean, group = letra_desc, color = letra_desc), size = 1.10) +
    theme_minimal() +
    scale_y_continuous(labels = comma) +
    scale_color_viridis_d(labels = label_wrap(15)) +
    ggtitle("Evolución histórica de los salarios nominales en 4 sectores") +
    labs(x = "Año", 
         y = "Salario mensual promedio",
         color = "Sector")

```
